.\" Page by b.hubert - may be freely modified and distributed
.\"
.\" Niki A. Rahimi (LTC Security Development, narahimi@us.ibm.com)
.\" added ERRORS section.
.\"
.\" Traduction Christophe Blaess <ccb@club-internet.fr>
.\" Màj 18/07/2003 LDP-1.56
.\" Màj 01/05/2006 LDP-1.67.1
.\"
.TH FUTEX 2 "31 décembre 2002" LDP "Manuel du programmeur Linux"
.SH NOM
futex \- Mécanisme de verrouillage rapide en mode utilisateur.
.SH SYNOPSIS
.sp
.B "#include <linux/futex.h>"
.sp
.B "#include <sys/time.h>"
.sp
.BI "int sys_futex (void *" futex ", int " op ", int " val ", const struct timespec *" timeout );
.SH "DESCRIPTION"
.PP
L'appel système
.B sys_futex
donne à un programme la possibilité d'attendre qu'une valeur à une adresse donnée
change, ou de réveiller tous ceux qui sont en attente sur cette adresse. Bien
que les adresses soient différentes dans des processus séparés, le noyau
fera la correspondance lors de l'appel système.
Ceci est typiquement employé pour implémenter
les verrous en mémoire partagée, tels qu'ils
sont décrits dans
.BR futex (4).
.PP
Quant une opération
.BR futex (4)
ne se termine pas de manière satisfaisante dans l'espace utilisateur, un appel
au noyau est nécessaire pour l'arbitrage. Ceci signifie soit endormir le
processus appelant, soit réveiller le processus en attente.
.PP
Les appelants de cette fonction doivent accepter les sémantiques décrites dans
.BR futex (4).
Comme celles-ci impliquent l'écriture d'instructions non portables en assembleur,
leurs utilisateurs sont des auteurs de bibliothèques plus que des développeurs applicatifs.
.PP
L'argument
.I futex
doit pointer sur un entier aligné qui stocke le compteur. L'opération à exécuter
est transmise dans le paramètre
.IR op ,
avec la valeur
.IR val .
.PP
Trois opérations sont définies pour le moment\ :
.TP
.B FUTEX_WAIT
Cette opération vérifie que l'adresse du futex contient toujours la valeur indiquée
et s'endort en attendant un
.I FUTEX_WAKE
à cette adresse. Les deux étapes sont liées atomiquement. Si l'argument
.I timeout
est non nul, il contient la durée maximale de sommeil. Sinon elle est infinie.
D'après
.BR futex (4),
cet appel est exécuté si la décrémentation du compteur donne une valeur négative
(indiquant un conflit) et le sommeil durera jusqu'à ce qu'un autre processus
relâche le futex et exécute
.BR FUTEX_WAKE .
.TP
.B FUTEX_WAKE
Cette opération réveille au plus
.I val
processus en attente sur l'adresse du futex (endormis dans
.IR FUTEX_WAIT ).
D'après
.BR futex (4),
ceci est exécuté si l'incrémentation du compteur montre qu'il y a des processus
en attente, une fois que la valeur du futex a été mise à 1 (indiquant qu'il
est disponible).
.TP
.B FUTEX_FD
Pour permettre des réveils asynchrones, cette opération associe un descripteur de
fichier avec un futex. Si un autre processus exécute un
.BR FUTEX_WAIT ,
l'appelant recevra le signal dont le numéro a été indiqué dans
.IR val .
L'appelant doit refermer le descripteur de fichier après utilisation.

Pour éviter les situations de concurrence, l'appelant doit tester si le futex a
été libéré après le retour de
.BR FUTEX_FD .
.SH "VALEUR RENVOYÉE"
.PP
Suivant l'opération exécutée, la valeur renvoyée peut avoir différentes significations.
.TP
.B FUTEX_WAIT
Renvoie 0 si le processus a été réveillé par un
.BR FUTEX_WAKE .
Renvoie ETIMEDOUT en cas de dépasse de délai. Renvoie EWOULDBLOCK si le futex
n'avait pas la valeur attendue. L'arrivée d'un signal peut faire renvoyer EINTR.
.TP
.B FUTEX_WAKE
Renvoie le nombre de processus réveillés.
.TP
.B FUTEX_FD
Renvoie le nouveau descripteur associé au futex.
.SH "NOTES"
.PP
Répétons-le, les futex de base ne sont pas conçus comme une abstraction facile à
employer pour les utilisateurs. Les implémenteurs doivent maitriser l'assembleur
et avoir lu les sources de la bibliothèque en espace utilisateur décrite plus bas.
.SH "AUTEURS"
.PP
Les futex ont été conçus et créés par Hubertus Franke (IBM Thomas J. Watson Research Center),
Matthew Kirkwood, Ingo Molnar (Red Hat) et Rusty Russell (IBM Linux Technology Center).
Cette page a été écrite par Bert Hubert.
.SH "VERSIONS"
.PP
Le support initial des futex a été ajouté dans Linux 2.5.7 mais avec une sémantique
différente de celle décrite ci-dessus, qui est disponible depuis Linux 2.5.40.
.SH "VOIR AUSSI"
.PP
.BR futex (4),

«\ Fuss, Futexes and Furwocks: Fast Userlevel Locking in Linux\ » (proceedings of the Ottawa Linux Symposium 2002),

Bibliothèque futex-*.tar.bz2 <URL:ftp://ftp.nl.kernel.org:/pub/linux/kernel/people/rusty/>.
.SH TRADUCTION
.PP
Ce document est une traduction réalisée par Christophe Blaess
<http://www.blaess.fr/christophe/> le 18\ juillet\ 2003
et révisée le 2\ mai\ 2006.
.PP
L'équipe de traduction a fait le maximum pour réaliser une adaptation
française de qualité. La version anglaise la plus à jour de ce document est
toujours consultable via la commande\ : «\ \fBLANG=en\ man\ 2\ futex\fR\ ».
N'hésitez pas à signaler à l'auteur ou au traducteur, selon le cas, toute
erreur dans cette page de manuel.
