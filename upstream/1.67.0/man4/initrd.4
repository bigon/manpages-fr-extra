.\" -*- nroff -*- 
.\" This man-page is Copyright (C) 1997 John S. Kallal
.\"
.\" Permission is granted to make and distribute verbatim copies of this
.\" manual provided the copyright notice and this permission notice are
.\" preserved on all copies.
.\"
.\" Permission is granted to copy and distribute modified versions of this
.\" manual under the conditions for verbatim copying, provided that the
.\" entire resulting derived work is distributed under the terms of a
.\" permission notice identical to this one
.\" 
.\" Since the Linux kernel and libraries are constantly changing, this
.\" manual page may be incorrect or out-of-date.  The author(s) assume no
.\" responsibility for errors or omissions, or for damages resulting from
.\" the use of the information contained herein.  The author(s) may not
.\" have taken the same level of care in the production of this manual,
.\" which is licensed free of charge, as they might when working
.\" professionally.
.\" 
.\" Formatted or processed versions of this manual, if unaccompanied by
.\" the source, must acknowledge the copyright and author(s) of this work.
.\"
.\" If the you wish to distribute versions of this work under other
.\" conditions than the above, please contact the author(s) at the following 
.\" for permission:
.\"	
.\"  John S. Kallal - 
.\"	email: <kallal@voicenet.com>
.\"	mail: 518 Kerfoot Farm RD, Wilmington, DE 19803-2444, USA
.\"	phone: (302)654-5478
.\"   
.\" $Id: initrd.4,v 0.9 1997/11/07 05:05:32 kallal Exp kallal $
.\" Traduction 31/05/1998 par Christophe Blaess (ccb@club-internet.fr)
.\" LDP-man-pages-1.19
.\" MàJ 25/07/2003 LDP-1.56
.TH INITRD 4 "25 juillet 2003" LDP "Manuel du programmeur Linux"
.SH NOM
initrd \- Disque RAM initialisé au démarrage du système.
.SH DESCRIPTION
Le fichier spécial
.B /dev/initrd
est un périphérique bloc en lecture seule.
Ce périphérique
.B /dev/initrd
est un disque RAM qui est initialisé par le chargeur du système avant le
démarrage du noyau.
Ainsi, le noyau peut utiliser le contenu de ce périphérique bloc
pour un démarrage en deux phases.
.PP
Durant la première phase, le noyau démarre et monte la racine du système de fichiers
depuis le contenu de
.B /dev/initrd 
(par exemple un disque RAM initialisé par le chargeur).
Durant la seconde phase, les drivers supplémentaires, et les autres modules
sont chargés depuis le périphérique racine initial.
Après le chargement de ces modules supplémentaires, une nouvelle racine du système de
fichiers est montée à partir d'un périphérique différent.
.SH "DÉMARRAGE DU SYSTÈME" 
Quand il démarre en utilisant \fBinitrd\fP, le système procède comme suit:
.RS 0.2i
.PP
1. Le chargeur place une copie du noyau en mémoire, ainsi que le
contenu de \fB/dev/initrd\fP.
.PP
2. Au démarrage du noyau, celui-ci décompresse et recopie le contenu du
périphérique
.B /dev/initrd
sur le disque virtuel
.B /dev/ram0 
puis libère la mémoire utilisée par
.BR /dev/initrd "."
.PP
3. Le noyau monte en lecture-écriture le périphérique
.B /dev/ram0 
comme racine initiale du système de fichiers.
.PP
4. Si la racine désirée pour le système de fichiers est également
celle que l'on vient de monter (par ex. \fB/dev/ram0\fP), le noyau
passe directement à la dernière étape du démarrage.
.PP
5. Si un fichier exécutable \fB/linuxrc\fP est présent sur le système
de fichiers racine initial, ce fichier est exécuté avec l'uid 0.
(Le fichier
.B /linuxrc
doit avoir la permission d'exécution. Ce peut être n'importe quel
exécutable, y compris un shell-script.)
.PP
6. Si
.B /linuxrc
n'est pas exécuté ou lorsqu'il se termine,
la racine normale du système de fichiers est montée.
(Si
.BR /linuxrc 
se termine en ayant monté d'autres systèmes de fichiers sur la racine
initiale, alors le comportement du noyau est
.BR INDÉTERMINÉ "."
Voir le paragraphe
.BR NOTES 
pour le comportement effectif.)
.PP
7. Si la racine normale dispose d'un répertoire
.BR /initrd ,
le périphérique
.B /dev/ram0
est déplacé depuis
.BR / " vers " /initrd "."
Sinon, si le répertoire
.B /initrd
n'existe pas, le périphérique
.B /dev/ram0
est démonté.
(Lors du déplacement de
.BR / " vers " /initrd ", " /dev/ram0
n'est pas démonté, aussi des processus peuvent continuer à s'exécuter depuis ce périphérique.
Si le répertoire
.BR /initrd 
n'existe pas sur le système de fichiers normal, et si des processus continuent à s'exécuter
depuis
.BR /dev/ram0 " lorsque " /linuxrc 
se termine, le comportement du noyau est
.BR INDÉTERMINÉ "."
Voir le paragraphe
.BR NOTES 
pour le comportement effectif.)
.PP
8. La séquence de démarrage habituelle (invocation de
.BR /sbin/init )
est alors effectuée depuis le système de fichiers normal.
.\"   
.SH OPTIONS
Lorsque l'on utilise
.BR initrd ,
les options suivantes du chargeur affectent les opération
de démarrage du noyau:
.TP
.BI initrd= "nom_de_fichier"
Indique le fichier à charger comme contenu de
.BR /dev/initrd "."
Pour \fBLOADLIN\fP, il s'agit d'une option en ligne de commande.
Pour \fBLILO\fP il faut utiliser cette commande dans le fichier
de configuration \fI/etc/lilo.config\fP.
Le fichier mentionné avec cette option sera typiquement une image
compressée par 
.BR gzip (1),
du système de fichiers.
.TP
.B noinitrd
Cette option désactive le démarrage en deux étapes. Le noyau se
comporte comme si
.B /dev/initrd 
n'était pas initialisé. Avec cette option, le contenu de
.BR /dev/initrd ,
une fois chargé en mémoire sera préservé. Ce contenu peut alors
être n'importe quelle donnée, et pas uniquement une image d'un
système de fichiers.
Néanmoins, le périphérique
.B /dev/initrd 
est en lecture seule, et ne peut être lu qu'une seule fois après
le démarrage du système.
.TP
.BI root= "nom_de_périphérique"
Indique le nom du périphérique à utiliser comme racine normale du système de fichiers.
Pour \fBLOADLIN\fP, il s'agit d'une option en ligne de commande.
Pour \fBLILO\fP il faut utiliser cette commande dans le fichier
de configuration \fI/etc/lilo.config\fP.
Le périphérique indiqué ici doit être montable et contenir un système de fichiers convenable.
.\"   
.SH "MODIFICATION DE LA RACINE DU SYSTÈME DE FICHIERS"
Le système de fichiers utilisé comme racine par défaut est celui
qui est compilé dans le noyau (ou configuré avec
.BR rdev ),
ou celui qui est spécifié par une option du chargeur.
Pour accéder à un système de fichiers monté par NFS, il faut utiliser les
options de démarrage
.BR nfs_root_name " et " nfs_root_addrs 
pour la configuration NFS.
Pour plus d'information sur les racines de systèmes de fichiers montées par NFS,
consultez le fichier
.BR nfsroot.txt ,
dans la documentation du noyau.
Pour plus d'informations sur la configuration de la racine du système de fichiers,
voyez également les documentations de
.BR LILO " et " LOADLIN .
.PP
On peut aussi faire effectuer la modification de la racine normale par l'exécutable
.BR /linuxrc .
Pour ce faire, le système
.B /proc
doit être monté. Ensuite, 
.B /linuxrc 
modifie le périphérique racine en écrivant directement dans les fichiers
.BR /proc/sys/kernel/real-root-dev ", "
.BR /proc/sys/kernel/nfs-root-name ", et " 
.BR /proc/sys/kernel/nfs-root-addrs "."
Pour un périphérique physique monté à la racine, le changement s'effectue
en écrivant le numéro de périphérique du nouveau système de fichiers dans
.BR /proc/sys/kernel/real-root-dev "."
Pour un système monté par NFS, la modification se fait en écrivant la configuration
NFS dans les fichiers
.BR /proc/sys/kernel/nfs-root-name " et "
.BR /proc/sys/kernel/nfs-root-addrs 
puis en inscrivant 0xff (c.-à-d. le numéro de pseudo-périphérique NFS) dans le fichier
.BR /proc/sys/kernel/real-root-dev "."
Par exemple, la ligne de commande suivant basculerait le périphérique racine normale
sur
.BR /dev/hdb1 :
.nf
        echo 0x365 >/proc/sys/kernel/real-root-dev
.fi
La ligne suivante modifierait le périphérique normal en un répertoire NFS
.BR /var/nfsroot 
sur un serveur local ayant l'adresse IP 193.8.232.7, ceci sur un système nommé idefix,
se trouvant à l'adresse 193.8.232.7:
.nf
	echo /var/nfsroot >/proc/sys/kernel/nfs-root-name
	echo 193.8.232.2:193.8.232.7::255.255.255.0:idefix \\
	  >/proc/sys/kernel/nfs-root-addrs
	echo 255 >/proc/sys/kernel/real-root-dev
.fi
.\"   
.SH "UTILISATION"
L'intérêt principal d'implémenter
.BR initrd 
était de permettre une configuration modulaire du noyau lors de l'installation
du système.
.PP
Un scénario possible d'installation est le suivant:
.RS 0.2i
.PP
1. Le programme de chargement démarre depuis une disquette, ou un autre support,
avec un noyau minimal (par exemple les supports pour
.BR /dev/ram ", " /dev/initrd ,
et le système de fichiers ext2). Puis charge
.BR /dev/initrd
depuis une version compressée avec gzip d'un système de fichiers initial.
.PP
2. L'exécutable
.BR /linuxrc 
détermine ce qui est nécessaire pour (1) monter le système de fichiers
normal (pilotes de périphériques, systèmes de fichiers) et (2) utiliser
le support fourni pour la distribution (CD-ROM, réseau, bande magnétique).
Cette étape peut être effectué en interrogeant l'utilisateur, en effectuant
des tests de détection automatique, ou en utilisant une approche hybride entre
les deux.
.PP 
3. L'exécutable
.BR /linuxrc 
charge les modules nécessaires depuis le système de fichiers initial.
.PP
4. L'exécutable
.BR /linuxrc 
crée et remplit le système de fichiers racine. (A cet instant, le système
de fichiers racine n'est pas nécessairement complet).
.PP
5. L'exécutable
.BR /linuxrc " configure " /proc/sys/kernel/real-root-dev,
démonte
.BR /proc ", "
le système de fichiers normal, et tout autre système de fichiers qu'il
a éventuellement monté, et se termine.
.PP
6. Le noyau monte alors le système de fichiers racine normal.
.PP
7. Maintenant que le système de fichiers est accessible,
le chargeur peut être installé.
.PP
8. Le chargeur est configuré pour installer dans
.BR /dev/initrd
un système de fichiers disposant de l'ensemble des modules qui ont été utilisés pour
démarrer le système.
(par exemple un périphérique comme
.BR /dev/ram0 
peut être modifié, puis démonté, et finalement l'image est recopiée depuis
.BR /dev/ram0 
vers un fichier.)
.PP
9. Le système est maintenant prêt à redémarrer, et les tâches supplémentaires
d'installation peuvent être effectuées.
.RE
.PP
Le principal avantage offert par
.BR /dev/initrd 
dans ce scénario est de permettre de réutiliser les données de configuration
lors du fonctionnement normal du noyau, sans nécessiter de choisir un noyau
initial, d'utiliser un gros noyau générique, ou de recompiler le noyau après
l'installation.
.PP
Un second scénario sert à l'installation 
de Linux sur un réseau constitué de machines configurées différemment.
Dans ce cas, il peut être préférable de n'utiliser qu'un nombre minimal
de noyaux (voire un seul dans le meilleur des cas), et de ne stocker
qu'une quantité la plus faible possible d'information de configuration.
Ainsi, on crée un fichier commun contenant tous les modules nécessaires,
et seul le fichier
.BR /linuxrc ,
ou les fichiers qu'il lance,
changent suivant les machines.
.PP
Un troisième scénario permet de disposer de disques de secours les plus
confortables possible. Les informations comme l'emplacement du système
de fichiers racines, etc. ne sont pas indispensables lors du démarrage.
Le système chargé par
.B /dev/initrd 
peut utiliser des menus de dialogue et/ou des détections automatiques suivi
de vérification de cohérence du système.
.PP
Enfin, et c'est peut-être l'usage le plus important, les distributions de
Linux sur CD-ROM permettent une installation plus aisée.
La distribution peut utiliser directement
.BR LOADLIN 
pour charger
.BR /dev/initrd
depuis le CD-ROM sans avoir besoin de créer de disquettes.
La distribution peut également utiliser une disquette de démarrage avec
.BR LILO 
puis charger un disque ram par l'intermédiaire de
.BR /dev/initrd " depuis le CD-ROM."
.\"   
.\"   
.\"   
.SH CONFIGURATION
.B /dev/initrd 
est un périphérique bloc en lecture-seule, dont le numéro majeur est 1,
et le mineur 250.
Typiquement,
.B /dev/initrd
appartient à
.B root.disk 
et dispose du mode 0400 (lecture uniquement par root).
Si votre système Linux n'a pas encore de fichier
.BR /dev/initrd ,
vous pouvez le créer en utilisant les commandes suivantes :
.nf
\fB
        mknod -m 400 /dev/initrd b 1 250
        chown root:disk /dev/initrd
\fP
.fi
Il faut également que les options "disque Ram" et "Disque Ram initial"
(par exemple
.BR CONFIG_BLK_DEV_RAM=y " et " CONFIG_BLK_DEV_INITRD=y
) soient compilées directement dans le noyau Linux pour pouvoir utiliser
.BR /dev/initrd "."
Lors de l'utilisation de
.BR /dev/initrd ", "
le pilote de disque Ram ne peut pas être chargé en tant que module.
.\"   
.\"   
.\"   
.SH FICHIERS
.I /dev/initrd
.br
.I /dev/ram0
.br
.I /linuxrc
.br
.I /initrd
.SH "VOIR AUSSI"
.BR chown (1),
.BR mknod (1),
.BR ram (4),
.BR freeramdisk (8),
.BR rdev (8),
Le fichier
.I initrd.txt
dans les sources du noyau, la documentation de LILO, celle de LOADLIN,
et la documentation SYSLINUX.
.\"   
.SH NOTES
1. Avec le noyau actuel, tout système de fichier reste monté lors du déplacement
de
.BR /dev/ram0 " depuis " / " vers " /initrd ,
et continue à être accessible. Néanmoins, les entrées de
.BR /proc/mounts 
ne sont pas mises à jour.
.PP
2. Avec le noyau actuel, si le répertoire
.BR /initrd " n'existe pas, alors " /dev/ram0 
ne sera PAS complètement démonté si
.BR /dev/ram0 
est utilisé par un processus ou si un système de fichiers a été monté dessus.
Si
.BR /dev/ram0 " n'est PAS complètement démonté, " 
alors
.BR /dev/ram0
restera chargé en mémoire.
.PP
3. Les utilisateurs de
.BR /dev/initrd 
ne doivent pas compter sur les comportements décrits dans les deux notes
précédentes. Ces comportements peuvent changer dans les versions futures
du noyau Linux.
.\"   
.SH AUTEURS
Le code du noyau pour le périphérique
.BR initrd 
a été écrit par Werner Almesberger <almesber@lrc.epfl.ch> et
Hans Lermen <lermen@elserv.ffm.fgan.de>.
Le code de
.BR initrd 
a été introduit dans le noyau Linux de base dans la version de développement 1.3.73.

.SH TRADUCTION
Christophe Blaess, 1998-2003.
